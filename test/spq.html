<!DOCTYPE html> 
<html> 
  <head> 
  <meta charset="UTF-8">
  <title>Spanish word quiz</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1,minimum-scale=1, maximum-scale=1"> 
  <link rel="stylesheet" href="jquery.mobile-1.0.min.css" />
  <script src="jquery-1.7.1.min.js"></script>
  <script src="data.js"></script>
  <script src="mt.js"></script>
  <script>
  $(document).bind("mobileinit", function() {
    $.mobile.page.prototype.options.addBackBtn = true;
  });
  var count;
  var correct_count;
  var cur_page = 0;
  var correct_one;
  var max_option_count = 4;
  var option_count = 2;
  var is_reversed = false;
  var is_random = false;
  var random_seed = (new Date()).getTime();
  var mt = new MersenneTwister(random_seed);
  var missed;

  Array.prototype.shuffle_fy = function() {
    var i = this.length;
    while(i){
      var j = mt.nextInt(0, i);
      var t = this[--i];
      this[i] = this[j];
      this[j] = t;
    }
    return this;
  }

  $(function(){
    if (!localStorage.has_data) {
      document.location.hash = "#select_direction";
    } else {
      document.location.hash = "#index";
    }
  })

  function init_options() {
    for (var i = 0; i < 2; ++i) {
      for (var j = option_count; j < max_option_count; ++j) {
        $("#li_" + i + "_" + j).hide();
      }
    }
  }

  function continue_game() {
    init_options();
    count = parseInt(localStorage.count);
    correct_count = parseInt(localStorage.correct_count);
    is_reversed = (localStorage.is_reversed == "true");
    is_random = (localStorage.is_random == "true");
    random_seed = parseInt(localStorage.random_seed);
    mt = new MersenneTwister(random_seed);
    missed = (localStorage.missed == "true");
    cur_page = 0;
    if (is_random) {
      data.shuffle_fy();
    }
    next_question();
  }

  function start_game() {
    init_options();
    count = 0;
    correct_count = 0;
    missed = false;
    localStorage.has_data = true;
    localStorage.count = count;
    localStorage.correct_count = correct_count;
    localStorage.is_reversed = is_reversed;
    localStorage.is_random = is_random;
    localStorage.random_seed = random_seed;
    localStorage.missed = missed;
    if (is_random) {
      data.shuffle_fy();
    }
    next_question();
  }

  function next_question() {
    $("#footer0,#footer1").text("" + correct_count + "/" + (count + (missed ? 1 : 0)));
    correct_one = mt.nextInt(0, option_count);
    var source = is_reversed ? 1 : 0;
    var dest = is_reversed ? 0 : 1;
    $("#title" + cur_page).text(data[count][source]);
    used_dict = {};
    used_dict[count] = true;
    for (var i = 0; i < option_count; ++i) {
      var r;
      while (true) {
        r = mt.nextInt(0, data.length);
        if (data[r][2] != data[count][2]) continue;
        if (used_dict[r]) continue;
        break;
      }
      used_dict[r] = true;
      $("#option_" + cur_page + "_" + i).text(data[r][dest]);
    }
    $("#option_" + cur_page + "_" + correct_one).text(data[count][dest]);
    localStorage.count = count;
    localStorage.correct_count = correct_count;
    localStorage.missed = missed;
    ++count;
    if (count == data.length) {
      count = 0;
      correct_count = 0;
    }
  }

  function button_touch(page, num) {
    if (page != cur_page) {
      return;
    }
    elem = $("#option_" + cur_page + "_" + num);
    elem.text(elem.text() + " " + (num == correct_one ? "◯" : "×"));

    cur_page = 1 - cur_page;
    if (num == correct_one) {
      if (!missed) {
        ++correct_count;
      }
      missed = false;
    } else {
      missed = true;
      --count;
    }
    next_question();
  }

  </script>
  <style>
  .big { font-size: 300%; }
  .in, .out {
    -webkit-animation-duration: 250ms;
  }
  </style>
  <script src="jquery.mobile-1.0.min.js"></script>
</head>
<body>
  <div data-role="page" id="index" data-theme="b">
    <div data-role="header">
      <h3>単語帳</h3>
    </div>
    <div data-role="content">
      <ul data-role="listview" data-inset="true">
        <li data-role="list-divider"><span class="big">メニュー</span></li>
        <li><a href="#select_direction">
          <h3>はじめから</h3>
        </a></li>
        <li id="continue_game" onclick="continue_game();"><a href="#page0">
          <h3>つづきから</h3>
        </a></li>
      </ul>
    </div>
    <div data-role="footer">
      <h3></h3>
    </div>
  </div>
  <div data-role="page" id="select_direction" data-theme="b">
    <div data-role="header">
      <h3>単語帳</h3>
    </div>
    <div data-role="content">
      <ul data-role="listview" data-inset="true">
        <li data-role="list-divider"><span class="big">出題方向</span></li>
        <li onclick="is_reversed=false;"><a href="#select_type">
          <h3>西→日</h3>
        </a></li>
        <li onclick="is_reversed=true;"><a href="#select_type">
          <h3>日→西</h3>
        </a></li>
      </ul>
    </div>
    <div data-role="footer">
      <h3></h3>
    </div>
  </div>
  <div data-role="page" id="select_type" data-theme="b">
    <div data-role="header">
      <h3>単語帳</h3>
    </div>
    <div data-role="content">
      <ul data-role="listview" data-inset="true">
        <li data-role="list-divider"><span class="big">出題順</span></li>
        <li><a onclick="is_random=false;start_game();" href="#page0">
          <h3>リスト順</h3>
        </a></li>
        <li onclick="is_random=true;start_game();"><a href="#page0">
          <h3>ランダム</h3>
        </a></li>
      </ul>
    </div>
    <div data-role="footer">
      <h3></h3>
    </div>
  </div>
  <div data-role="page" id="page0" data-theme="b">
    <div data-role="header">
      <a href="#index" data-direction="reverse">メニュー</a>
      <h3>単語帳</h3>
    </div>
    <div data-role="content">
      <ul data-role="listview" data-inset="true">
        <li data-role="list-divider"><span id="title0" class="big"></span></li>
        <li id="li_0_0" onclick="button_touch(0, 0);"><a href="#page1">
          <h3 id="option_0_0"></h3>
        </a></li>
        <li id="li_0_2" onclick="button_touch(0, 2);"><a href="#page1">
          <h3 id="option_0_2"></h3>
        </a></li>
        <li id="li_0_3" onclick="button_touch(0, 3);"><a href="#page1">
          <h3 id="option_0_3"></h3>
        </a></li>
        <li id="li_0_1" onclick="button_touch(0, 1);"><a href="#page1">
          <h3 id="option_0_1"></h3>
        </a></li>
      </ul>
    </div>
    <div data-role="footer">
      <h3><span id="footer0"></span></h3>
    </div>
  </div>
  <div data-role="page" id="page1" data-theme="b">
    <div data-role="header">
      <a href="#index" data-direction="reverse">メニュー</a>
      <h3>単語帳</h3>
    </div>
    <div data-role="content">
      <ul data-role="listview" data-inset="true">
        <li data-role="list-divider"><span id="title1" class="big"></span></li>
        <li id="li_1_0" onclick="button_touch(1, 0);"><a href="#page0">
          <h3 id="option_1_0"></h3>
        </a></li>
        <li id="li_1_2" onclick="button_touch(1, 2);"><a href="#page0">
          <h3 id="option_1_2"></h3>
        </a></li>
        <li id="li_1_3" onclick="button_touch(1, 3);"><a href="#page0">
          <h3 id="option_1_3"></h3>
        </a></li>
        <li id="li_1_1" onclick="button_touch(1, 1);"><a href="#page0">
          <h3 id="option_1_1"></h3>
        </a></li>
      </ul>
    </div>
    <div data-role="footer">
      <h3><span id="footer1"></span></h3>
    </div>
  </div>
</body>
</html>
