<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>test</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="jquery.touchSwipe-1.2.4.js"></script>
<style type="text/css">
table {
width: 960px;
height: 960px;
border-collapse: collapse;
border: 1px solid;
}
td {
font-size: 160px;
width: 320px;
height: 320px;
text-align: center;
border: solid 1px black;
}
</style>
<script>
var is_touch = ('ontouchstart' in window);
var kCellSize = 320;
var touch_state = {};
var kSubKeypadData = [
  ['', 'う', '', 'い', 'あ', 'え', '', 'お', ''],
  ['', 'く', '', 'き', 'か', 'け', '', 'こ', ''],
  ['', 'す', '', 'し', 'さ', 'せ', '', 'そ', ''],
  ['', 'つ', '', 'ち', 'た', 'て', '', 'と', ''],
  ['', 'ぬ', '', 'に', 'な', 'ね', '', 'の', ''],
  ['', 'ふ', '', 'ひ', 'は', 'へ', '', 'ほ', ''],
  ['', 'む', '', 'み', 'ま', 'め', '', 'も', ''],
  ['', 'ゆ', '',   '', 'や',   '', '', 'よ', ''],
  ['', 'る', '', 'り', 'る', 'れ', '', 'ろ', '']
];

function ToIndex(x, y) {
  if (x < -1 || x > 1 || y < -1 || y > 1) {
    return -1;
  }
  return x + 1 + (y + 1) * 3;
}

function TouchStart(e) {
  e.preventDefault();
  touch_state.touched = true;
  touch_state.cell_sequence = [[0, 0]];
  touch_state.start_x = (is_touch ? event.changedTouches[0].pageX : e.pageX);
  touch_state.start_y = (is_touch ? event.changedTouches[0].pageY : e.pageY);
  $('#basic_keypad').css('top', touch_state.start_y - $('#basic_keypad').height() / 2)
                    .css('left', touch_state.start_x - $('#basic_keypad').width() / 2)
                    .show();
  touch_state.cell_base_x = 0;
  touch_state.cell_base_y = 0;
  touch_state.keypad_state = 'basic';
}

function TouchMove(e) {
  if (!touch_state.touched) {
    return;
  }
  e.preventDefault();
  touch_state.current_x = (is_touch ? event.changedTouches[0].pageX : e.pageX);
  touch_state.current_y = (is_touch ? event.changedTouches[0].pageY : e.pageY);
  var prev_cell = touch_state.cell_sequence[touch_state.cell_sequence.length - 1];
  for (var x = -2; x <= 2; ++x) {
    for (var y = -2; y <= 2; ++y) {
      if (Math.sqrt(
        Math.pow(touch_state.current_x - (touch_state.start_x + x * kCellSize), 2) +
        Math.pow(touch_state.current_y - (touch_state.start_y + y * kCellSize), 2)) < kCellSize / 2 &&
        !(x == prev_cell[0] && y == prev_cell[1])) {
        touch_state.cell_sequence.push([x, y]);
      }
    }
  }
  var cur_cell = touch_state.cell_sequence[touch_state.cell_sequence.length - 1];
  cell_offset_x = cur_cell[0] - touch_state.cell_base_x;
  cell_offset_y = cur_cell[1] - touch_state.cell_base_y;
  var index = ToIndex(cell_offset_x, cell_offset_y);
  if ((touch_state.keypad_state == 'basic2' && index >=0 && index < 9) ||
      (touch_state.keypad_state == 'basic' && index >= 0 && index < 9 && index != 4)) {
    for (var i = 0; i < 9; ++i) {
      if (kSubKeypadData[index][i] == '') {
        $('#sub_' + i).css('border', 'none');
      } else {
        $('#sub_' + i).text(kSubKeypadData[index][i]);
      }
    }
    $('#sub_keypad').css('top', touch_state.start_y - $('#sub_keypad').height() / 2 +
                         cell_offset_y * kCellSize)
                    .css('left', touch_state.start_x - $('#sub_keypad').width() / 2 +
                         cell_offset_x * kCellSize)
                    .show();
    touch_state.keypad_state = 'sub';
    touch_state.cell_base_x = cur_cell[0];
    touch_state.cell_base_y = cur_cell[1];
  } else if (touch_state.keypad_state == 'sub') {
    var base_index = ToIndex(touch_state.cell_base_x, touch_state.cell_base_y);
    if (kSubKeypadData[base_index][index] == '') {
      touch_state.keypad_state = 'basic2';
    }
  }
}

function TouchEnd(e) {
  if (!touch_state.touched) {
    return;
  }
  e.preventDefault();
  touch_state.current_x = (is_touch ? event.changedTouches[0].pageX : e.pageX);
  touch_state.current_y = (is_touch ? event.changedTouches[0].pageY : e.pageY);
  var prev_cell = touch_state.cell_sequence[touch_state.cell_sequence.length - 1];
  for (var x = -2; x <= 2; ++x) {
    for (var y = -2; y <= 2; ++y) {
      if (Math.sqrt(
        Math.pow(touch_state.current_x - (touch_state.start_x + x * kCellSize), 2) +
        Math.pow(touch_state.current_y - (touch_state.start_y + y * kCellSize), 2)) < kCellSize / 2 &&
        !(x == prev_cell[0] && y == prev_cell[1])) {
        touch_state.cell_sequence.push([x, y]);
      }
    }
  }
  var cur_cell = touch_state.cell_sequence[touch_state.cell_sequence.length - 1];
  cell_offset_x = cur_cell[0] - touch_state.cell_base_x;
  cell_offset_y = cur_cell[1] - touch_state.cell_base_y;
  if (touch_state.keypad_state == 'sub') {
    var base_index = ToIndex(touch_state.cell_base_x, touch_state.cell_base_y);
    var index = ToIndex(cell_offset_x, cell_offset_y);
    $('#state_area').text($('#state_area').text() + kSubKeypadData[base_index][index]);
  }
  touch_state.keypad_state = 'none';
  $('#sub_keypad').hide();
  $('#basic_keypad').hide();
}

$(document).ready(function(){
touch_state.keypad_state = 'none';
$(document.body).bind({
  'touchstart mousedown': TouchStart,
  'touchmove mousemove': TouchMove,
  'touchend mouseup': TouchEnd
});
});

</script>
</head>
<body>
<span id='state_area'></span>
<table id='basic_keypad' style='display: none; position: absolute;'>
<tr>
<td>あ</td>
<td>か</td>
<td>さ</td>
</tr>
<tr>
<td>た</td>
<td>な</td>
<td>は</td>
</tr>
<tr>
<td>ま</td>
<td>や</td>
<td>ら</td>
</tr>
</table>
<table id='sub_keypad' style='display: none; border: none; position: absolute;'>
<tr>
<td id='sub_0'></td>
<td id='sub_1'></td>
<td id='sub_2'></td>
</tr>
<tr>
<td id='sub_3'></td>
<td id='sub_4'></td>
<td id='sub_5'></td>
</tr>
<tr>
<td id='sub_6'></td>
<td id='sub_7'></td>
<td id='sub_8'></td>
</tr>
</table>
</body>
</html>







